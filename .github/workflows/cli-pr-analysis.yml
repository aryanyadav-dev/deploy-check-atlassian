name: Deployment Risk Analysis

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  analyze:
    name: Analyze Deployment Risks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Build CLI
        run: pnpm --filter @dra/cli run build

      - name: Run deployment risk analysis
        id: analysis
        run: |
          node apps/cli/dist/index.js analyze \
            --base ${{ github.event.pull_request.base.sha }} \
            --head ${{ github.event.pull_request.head.sha }} \
            --json > analysis-result.json 2>&1 || true
          
          RISK_LEVEL=$(jq -r '.riskLevel // "unknown"' analysis-result.json)
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT

      - name: Post analysis comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let analysisResult = {};
            try {
              analysisResult = JSON.parse(fs.readFileSync('analysis-result.json', 'utf8'));
            } catch (e) {
              console.log('Could not parse analysis results');
            }
            
            const riskLevel = analysisResult.riskLevel || 'unknown';
            const riskScore = analysisResult.riskScore || 0;
            const findings = analysisResult.findings || [];
            
            const badgeColors = {
              low: '2ea44f',
              medium: 'f9c513',
              high: 'd73a49',
              critical: 'b60205',
              unknown: '6a737d'
            };
            const badgeColor = badgeColors[riskLevel.toLowerCase()] || badgeColors.unknown;
            const badge = `![Risk Level](https://img.shields.io/badge/Risk-${riskLevel.toUpperCase()}-${badgeColor})`;
            
            let body = `## ðŸ” Deployment Risk Analysis\n\n`;
            body += `${badge} **Score: ${riskScore}/100**\n\n`;
            
            if (findings.length === 0) {
              body += `âœ… No deployment risks detected.\n`;
            } else {
              body += `### Findings (${findings.length})\n\n`;
              body += `| Type | Severity | File | Description |\n`;
              body += `|------|----------|------|-------------|\n`;
              
              for (const finding of findings.slice(0, 20)) {
                const file = finding.filePath || '-';
                const desc = (finding.title || finding.description || '').substring(0, 60);
                body += `| ${finding.type} | ${finding.severity} | \`${file}\` | ${desc} |\n`;
              }
              
              if (findings.length > 20) {
                body += `\n*...and ${findings.length - 20} more findings*\n`;
              }
            }
            
            body += `\n---\n*Generated by deploy-check*`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Deployment Risk Analysis')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-risk-analysis
          path: analysis-result.json
          retention-days: 30

      - name: Fail on high risk
        if: steps.analysis.outputs.risk_level == 'high' || steps.analysis.outputs.risk_level == 'critical'
        run: |
          echo "::error::Deployment risk level is ${{ steps.analysis.outputs.risk_level }}. Please review findings."
          exit 1
